<!DOCTYPE html>
<html>
<head>
    <title>Lazyraiders</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Lazyraiders - v1.3.0</h1>
    <table>
        <thead>
            <tr>
                <th>腳色ID</th>
                <th>裝等</th>
                <th>T裝(s)</th>
                <th id="keys-threshold-header">keys</th>
                <th>總場數</th>
                <th>最高層數</th>
                <th>更新日期</th>
            </tr>
        </thead>
        <tbody id="raiderio-data">
        </tbody>
    </table>

    <script>
        fetch('settings.txt')
            .then(response => response.text())
            .then(settings => {
                const lines = settings.split('\n');
                const region = lines.find(line => line.startsWith('region=')).split('=')[1].trim();
                const tierSlots = lines.find(line => line.startsWith('tierSlots=')).split('=')[1].trim().split(/\s*,\s*/);
                const keyThreshold = parseInt(lines.find(line => line.startsWith('keyThreshold=')).split('=')[1].trim(), 10);

                document.getElementById('keys-threshold-header').textContent = `keys ${keyThreshold}+`;

                fetch('players.txt')
                    .then(response => response.text())
                    .then(text => {
                        const players = text.trim().split('\n');
                        const promises = players.map(player => {
                            const [name, playerRealm] = player.split('-');

                            // 先抓角色裝備資料
                            const gearUrl = `https://raider.io/api/v1/characters/profile?region=${region}&realm=${playerRealm}&name=${name}&fields=gear`;

                            return fetch(gearUrl)
                                .then(res => res.json())
                                .then(profile => {
                                    const gear = profile.gear;
                                    if (!gear) return null;

                                    // 計算T裝
                                    const tierPieces = {};
                                    tierSlots.forEach(slot => {
                                        if (gear.items && gear.items[slot] && gear.items[slot].tier && gear.items[slot].tier !== 999) {
                                            const item = gear.items[slot];
                                            tierPieces[item.tier] = (tierPieces[item.tier] || 0) + 1;
                                        }
                                    });

                                    // 再抓完整 M+ runs
                                    const runsUrl = `https://raider.io/api/v1/mythic-plus/runs/${region}/${playerRealm}/${name}`;
                                    return fetch(runsUrl)
                                        .then(res => res.json())
                                        .then(json => {
                                            const allRuns = json.runs || [];

                                            // 符合 threshold 的場數
                                            const keysThresholdPlus = allRuns.filter(run => run.mythic_level >= keyThreshold).length;

                                            // 最高層數 run
                                            let highestRun = null;
                                            if (allRuns.length > 0) {
                                                highestRun = allRuns.reduce((max, run) => run.mythic_level > max.mythic_level ? run : max, allRuns[0]);
                                            }

                                            return {
                                                name,
                                                ilvl: gear.item_level_equipped ? Math.round(gear.item_level_equipped) : null,
                                                tierPieces,
                                                keysThresholdPlus,
                                                totalRuns: allRuns.length,
                                                highestKey: highestRun ? highestRun.mythic_level : 'n/a',
                                                time: highestRun ? new Date(highestRun.completed_at).toISOString().split('T')[0] : 'n/a'
                                            };
                                        });
                                })
                                .catch(error => {
                                    console.error('Error fetching data for player:', name, error);
                                    return null;
                                });
                        });

                        Promise.all(promises).then(results => {
                            const validResults = results.filter(r => r !== null);
                            const sortedResults = validResults.sort((a, b) => (a.ilvl !== null ? a.ilvl : Infinity) - (b.ilvl !== null ? b.ilvl : Infinity));
                            const tbody = document.getElementById('raiderio-data');

                            sortedResults.forEach(result => {
                                const tr = document.createElement('tr');

                                const nameTd = document.createElement('td');
                                nameTd.textContent = result.name;
                                tr.appendChild(nameTd);

                                const ilvlTd = document.createElement('td');
                                ilvlTd.textContent = result.ilvl !== null ? result.ilvl : 'n/a';
                                tr.appendChild(ilvlTd);

                                const tierTd = document.createElement('td');
                                const tierText = Object.entries(result.tierPieces).map(([tier, count]) => `${tier} × ${count}`).join(', ');
                                tierTd.textContent = tierText || 'n/a';
                                tr.appendChild(tierTd);

                                const keysThresholdPlusTd = document.createElement('td');
                                keysThresholdPlusTd.textContent = result.keysThresholdPlus;
                                tr.appendChild(keysThresholdPlusTd);

                                const totalRunsTd = document.createElement('td');
                                totalRunsTd.textContent = result.totalRuns;
                                tr.appendChild(totalRunsTd);

                                const highestKeyTd = document.createElement('td');
                                highestKeyTd.textContent = result.highestKey;
                                tr.appendChild(highestKeyTd);

                                const timeTd = document.createElement('td');
                                timeTd.textContent = result.time;
                                tr.appendChild(timeTd);

                                tbody.appendChild(tr);
                            });
                        });
                    });
            });
    </script>
</body>
</html>
